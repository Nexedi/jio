<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>jIO Dashboard</title>
</head>
<body>
  <table border="1" style="width: 100%;">
    <tr style="font-style:italic;">
      <th>Storage Description</th>
    </tr>
    <tr>
      <th style="width:100%;">
        <textarea id="storagedescription" rows="10"
                  style="width:98%;"></textarea>
      </th>
    </tr>
    <tr>
      <td style="text-align: center;">
        <button onclick="fillMemoryDescription()">Memory</button>
        <button onclick="fillLocalDescription()">Local</button>
        <button onclick="fillDavDescription()">WebDAV</button>
        <button onclick="fillERP5Description()">ERP5</button>
        <button onclick="fillCustomDescription()">Custom</button>
        <button onclick="fillLastDescription()">Last</button>
      </td>
    </tr>
    <tr>
      <th><button onclick="createJIO()">Create JIO</button></th>
    </tr>
  </table>
  <br />
  <table border="1" style="width: 100%;">
    <tr>
      <td colspan="1" style="width: 50%;">
        <label for="metadata">Metadata or Parameters:</label>
        <textarea id="metadata" rows="3" style="width: 98%;">{}</textarea>
      </td>
      <td colspan="1" style="text-align: center;">
        Options:<br />
        <textarea id="options" rows="3" style="width: 98%;">{}</textarea>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="text-align: center;">
        <button onclick="post()">post</button>
        <button onclick="put()">put</button>
        <button onclick="get()">get</button>
        <button onclick="remove()">remove</button>
        - <button onclick="putAttachment()">putAttachment</button>
        <button onclick="getAttachment()">getAttachment</button>
        <button onclick="removeAttachment()">removeAttachment</button>
        - <button onclick="allDocs()">allDocs</button>
        - <button onclick="check()">check</button>
        <button onclick="repair()">repair</button>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="text-align: center;">
        <label for="times">Times</label>
        <input id="times" type="text" value="1" />
        <input id="times-lock" type="checkbox" checked="1" />
        <label for="times-lock">lock</label>
      </td>
    </tr>
  </table>
  <br />
  <div style="text-align: center;">
    <button onclick="printLocalStorage()">print localStorage</button>
    <button onclick="localStorage.clear()">clear localStorage</button><br />
    <button onclick="clearlog()">Clear Log</button>
  </div>
  <hr />
  <div id="log">
  </div>
  <script type="text/javascript">
    <!--
var log_color = "white";

function select(string) {
  return document.querySelector(string);
}
function logGetColor() {
  if (log_color === "white") {
    log_color = "cyan";
  } else {
    log_color = "white";
  }
  return log_color;
}
function log(o) {
  var node = document.createElement("pre");
  node.setAttribute(
    "style",
    "background-color:" + logGetColor() +
      ";margin:0;padding:0;"
  );
  if (typeof o === "string") {
    node.textContent = o;
  } else {
    node.textContent = JSON.stringify(o, null, "  ");
  }
  select("#log").appendChild(node);
}
function error(o) {
  var node = document.createElement("pre");
  node.setAttribute(
    "style",
    "background-color:" + logGetColor() +
      ";margin:0;padding:0;"
  );
  if (typeof o === "string") {
    node.textContent = o;
  } else {
    node.textContent = JSON.stringify(o);
  }
  select("#log").appendChild(node);
}
function clearlog() {
  select("#log").innerHTML = "";
}
// clear log on Alt+L
document.addEventListener("keypress", function (event) {
  if (event.altKey === true && event.charCode === 108) {
    clearlog();
  }
});
        //-->
  </script>
  <script src="../lib/rsvp/rsvp-custom.js"></script>
  <script src="../src/sha256.amd.js"></script>
  <script src="../jio.js"></script>
  <script src="../complex_queries.js"></script>
  <script src="../src/jio.storage/localstorage.js"></script>
  <script src="http://git.erp5.org/gitweb/uritemplate-js.git/blob_plain/HEAD:/bin/uritemplate-min.js"></script>
  <script src="../src/jio.storage/erp5storage.js"></script>
  <script type="text/javascript">
    <!--

var my_jio = null;

function fillMemoryDescription() {
  select("#storagedescription").value = JSON.stringify({
    "type": "local",
    "username": "<username>",
    "application_name": "<app_name>",
    "mode": "memory"
  }, null, "  ")
}
function fillLocalDescription() {
  select("#storagedescription").value = JSON.stringify({
    "type": "local",
    "username": "<username>",
    "application_name": "<app_name>"
  }, null, "  ")
}
function fillDavDescription() {
  select("#storagedescription").value = JSON.stringify({
    "type": "dav",
    "auth_type": "basic",
    "username": "<username>",
    "password": "<password>"
  }, null, "  ")
}
function fillERP5Description() {
  select("#storagedescription").value = JSON.stringify({
    "type": "erp5",
    "url": "<url/hateoas>"
  }, null, "  ")
}
function fillCustomDescription() {
  select("#storagedescription").value = JSON.stringify({
    "type": "<type>"
  }, null, "  ")
}
function fillLastDescription() {
  select("#storagedescription").value =
    localStorage.getItem("last_jio_description") || "{}";
}
fillLastDescription();

function createJIO() {
  var description;
  try {
    description = JSON.parse(select("#storagedescription").value);
    my_jio = jIO.createJIO(description);
    description = JSON.stringify(description, null, "  ");
    log("JIO created\n" + description);
    localStorage.setItem("last_jio_description", description);
  } catch (e) {
    error("Storage description is not JSON parsable");
  }
}

function printLocalStorage() {
  log("localStorage content\n" + JSON.stringify(localStorage, null, "  "));
}

function callback(err, val, begin_date) {
  log('time : ' + (Date.now() - begin_date));
  if (err) {
    return error('return :' + JSON.stringify(err, null, "  "));
  }
  log('return : ' + JSON.stringify(val, null, "  "));
}

function command(method) {
  var begin_date = Date.now(), doc = {}, opts = {};

  if (!my_jio) {
    return error('no jio set');
  }

  doc = JSON.parse(select('#metadata').value);
  opts = JSON.parse(select("#options").value);

  log(method + '\ndoc: ' + JSON.stringify(doc, null, "  ") +
      '\nopts: ' + JSON.stringify(opts, null, "  "));

  if (method === "allDocs") {
    my_jio.allDocs(opts).then(function (answer) {
      callback(undefined, answer, begin_date);
    }, function (error) {
      callback(error, undefined, begin_date);
    });
  } else {
    my_jio[method](doc, opts).then(function (answer) {
      callback(undefined, answer, begin_date);
    }, function (error) {
      callback(error, undefined, begin_date);
    });
  }
}

function doCommandNTimes(method) {
  var i = -1, n = 0, lock;
  n = parseInt(select("#times").value, 10);
  lock = select("#times-lock").checked;
  if (!lock) {
    select("#times").value = "1";
  }
  if (!isFinite(n)) {
    n = 1;
  }
  while (++i < n) {
    command(method);
  }
}

function post() {
  doCommandNTimes("post");
}
function put() {
  doCommandNTimes("put");
}
function get() {
  doCommandNTimes("get");
}
function remove() {
  doCommandNTimes("remove");
}
function putAttachment() {
  doCommandNTimes("putAttachment");
}
function getAttachment() {
  doCommandNTimes("getAttachment");
}
function removeAttachment() {
  doCommandNTimes("removeAttachment");
}
function allDocs() {
  doCommandNTimes("allDocs");
}
function check() {
  doCommandNTimes("check");
}
function repair() {
  doCommandNTimes("repair");
}
        //-->
  </script>
</body>
</html>
